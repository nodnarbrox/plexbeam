# ============================================================================
# PlexBeam â€” Full Stack Docker Compose
# ============================================================================
# Runs Plex with the PlexBeam cartridge + a remote GPU worker.
#
# Usage:
#   NVIDIA GPU (Linux):     docker compose --profile nvidia up -d
#   Intel QSV (Linux):      docker compose --profile intel up -d
#   VAAPI-WSL2 (Windows):   docker compose --profile vaapi-wsl up -d
#   Plex only:              docker compose up -d plex
#
# Linux with Intel GPU: also create docker-compose.override.yml to add
#   /dev/dri passthrough (see .env.example for details).
#
# Copy .env.example to .env and configure before starting.
# ============================================================================

services:
  # --- Plex Media Server with PlexBeam Cartridge ---
  plex:
    build:
      context: ./cartridge
      dockerfile: Dockerfile
    container_name: plexbeam-plex
    # Use 'network_mode: host' on Linux for best performance.
    # On Windows/macOS, use port mappings instead (host networking not supported).
    ports:
      - "32400:32400"
      - "1900:1900/udp"
      - "5353:5353/udp"
      - "8324:8324"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
      - "32469:32469"
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
      # PlexBeam cartridge settings
      - PLEXBEAM_WORKER_URL=${PLEXBEAM_WORKER_URL:-}
      - PLEXBEAM_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEXBEAM_SHARED_SEGMENT_DIR=${PLEXBEAM_SHARED_SEGMENT_DIR:-}
      - PLEXBEAM_UPDATE_REPO=${PLEXBEAM_UPDATE_REPO:-local}
    volumes:
      - ${PLEX_CONFIG_PATH:-./config/plex}:/config
      - ${MEDIA_PATH:-/mnt/media}:/media
      - ${PLEXBEAM_LOG_PATH:-./config/plex-cartridge-logs}:/var/log/plex-cartridge

  # --- GPU Worker: NVIDIA NVENC ---
  worker-nvidia:
    build:
      context: ./worker
      dockerfile: Dockerfile.nvidia
    container_name: plexbeam-worker-nvidia
    profiles:
      - nvidia
    restart: unless-stopped
    ports:
      - "${WORKER_PORT:-8765}:8765"
    environment:
      - PLEX_WORKER_HW_ACCEL=nvenc
      - PLEX_WORKER_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEX_WORKER_MAX_JOBS=${WORKER_MAX_JOBS:-3}
      - PLEX_WORKER_HOST=0.0.0.0
      - PLEX_WORKER_PORT=8765
    volumes:
      - ${WORKER_TEMP_PATH:-./config/worker-temp}:/app/transcode_temp
      - ${WORKER_LOG_PATH:-./config/worker-logs}:/app/logs
      - ${MEDIA_PATH:-/mnt/media}:/media:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, video]

  # --- GPU Worker: Intel QSV ---
  # Works on Windows (software fallback) and Linux (GPU via /dev/dri).
  # On Linux, add /dev/dri passthrough via docker-compose.override.yml:
  #   services:
  #     worker-intel:
  #       devices:
  #         - /dev/dri:/dev/dri
  worker-intel:
    build:
      context: ./worker
      dockerfile: Dockerfile.intel
    container_name: plexbeam-worker-intel
    profiles:
      - intel
    restart: unless-stopped
    ports:
      - "${WORKER_PORT:-8765}:8765"
    environment:
      - PLEX_WORKER_HW_ACCEL=${PLEX_WORKER_HW_ACCEL:-qsv}
      - PLEX_WORKER_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEX_WORKER_MAX_JOBS=${WORKER_MAX_JOBS:-3}
      - PLEX_WORKER_HOST=0.0.0.0
      - PLEX_WORKER_PORT=8765
    volumes:
      - ${WORKER_TEMP_PATH:-./config/worker-temp}:/app/transcode_temp
      - ${WORKER_LOG_PATH:-./config/worker-logs}:/app/logs
      - ${MEDIA_PATH:-/mnt/media}:/media:ro

  # --- GPU Worker: VAAPI-WSL2 (Windows with Intel/AMD GPU) ---
  # Uses Mesa D3D12 backend for GPU transcoding via WSL2.
  # Requires Windows 11 (or 10 21H2+), Intel 11th Gen+ or AMD GPU, and WSL2.
  # Prerequisites: run 'modprobe drm && modprobe vgem' in WSL2 (or add to /etc/wsl.conf)
  worker-vaapi-wsl:
    build:
      context: ./worker
      dockerfile: Dockerfile.vaapi-wsl
    container_name: plexbeam-worker-vaapi-wsl
    profiles:
      - vaapi-wsl
    restart: unless-stopped
    ports:
      - "${WORKER_PORT:-8765}:8765"
    environment:
      - PLEX_WORKER_HW_ACCEL=vaapi
      - PLEX_WORKER_QSV_DEVICE=/dev/dri/renderD128
      - PLEX_WORKER_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEX_WORKER_MAX_JOBS=${WORKER_MAX_JOBS:-3}
      - PLEX_WORKER_HOST=0.0.0.0
      - PLEX_WORKER_PORT=8765
      - LIBVA_DRIVER_NAME=d3d12
      - LD_LIBRARY_PATH=/usr/lib/wsl/lib
    devices:
      - /dev/dxg:/dev/dxg
      - /dev/dri:/dev/dri
    volumes:
      - ${WORKER_TEMP_PATH:-./config/worker-temp}:/app/transcode_temp
      - ${WORKER_LOG_PATH:-./config/worker-logs}:/app/logs
      - ${MEDIA_PATH:-/mnt/media}:/media:ro
      - /usr/lib/wsl:/usr/lib/wsl:ro
