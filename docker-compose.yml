# ============================================================================
# PlexBeam â€” Full Stack Docker Compose (Plex + Jellyfin)
# ============================================================================
# Runs Plex and/or Jellyfin with the PlexBeam cartridge + a remote GPU worker.
#
# Usage:
#   Plex only:              docker compose up -d plex
#   Jellyfin only:          docker compose up -d jellyfin
#   Both servers:           docker compose up -d plex jellyfin
#   NVIDIA GPU worker:      docker compose --profile nvidia up -d
#   Intel QSV worker:       docker compose --profile intel up -d
#
# NOTE: Intel GPU Docker workers do NOT work on Windows (WSL2 lacks i915/KMS).
# On Windows, run the worker bare-metal instead (see worker/ directory).
#
# Linux with Intel GPU: also create docker-compose.override.yml to add
#   /dev/dri passthrough (see .env.example for details).
#
# Copy .env.example to .env and configure before starting.
# ============================================================================

services:
  # --- Plex Media Server with PlexBeam Cartridge ---
  plex:
    build:
      context: ./cartridge
      dockerfile: Dockerfile
    container_name: plexbeam-plex
    # Use 'network_mode: host' on Linux for best performance.
    # On Windows/macOS, use port mappings instead (host networking not supported).
    ports:
      - "32400:32400"
      - "1900:1900/udp"
      - "5353:5353/udp"
      - "8324:8324"
      - "32410:32410/udp"
      - "32412:32412/udp"
      - "32413:32413/udp"
      - "32414:32414/udp"
      - "32469:32469"
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      - VERSION=docker
      - PLEX_CLAIM=${PLEX_CLAIM:-}
      # PlexBeam cartridge settings
      - PLEXBEAM_WORKER_URL=${PLEXBEAM_WORKER_URL:-}
      - PLEXBEAM_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEXBEAM_SHARED_SEGMENT_DIR=${PLEXBEAM_SHARED_SEGMENT_DIR:-}
      - PLEXBEAM_UPDATE_REPO=${PLEXBEAM_UPDATE_REPO:-local}
      - PLEXBEAM_CALLBACK_URL=${PLEXBEAM_CALLBACK_URL:-}
      # Beam mode: throttle upload to leave bandwidth for segment downloads.
      # Set to "1M" for WiFi, "0" for unlimited (wired Ethernet).
      - PLEXBEAM_UPLOAD_RATE=${PLEXBEAM_UPLOAD_RATE:-0}
    volumes:
      - ${PLEX_CONFIG_PATH:-./config/plex}:/config
      - ${MEDIA_PATH:-/mnt/media}:/media
      - ${PLEXBEAM_LOG_PATH:-./config/plex-cartridge-logs}:/var/log/plex-cartridge

  # --- Jellyfin Media Server with PlexBeam Cartridge ---
  jellyfin:
    build:
      context: ./cartridge
      dockerfile: Dockerfile.jellyfin
    container_name: plexbeam-jellyfin
    ports:
      - "8096:8096"
      - "8920:8920"
      - "7359:7359/udp"
    restart: unless-stopped
    environment:
      - PUID=${PUID:-1000}
      - PGID=${PGID:-1000}
      - TZ=${TZ:-America/New_York}
      # PlexBeam cartridge settings
      - PLEXBEAM_WORKER_URL=${PLEXBEAM_WORKER_URL:-}
      - PLEXBEAM_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEXBEAM_SHARED_SEGMENT_DIR=${PLEXBEAM_SHARED_SEGMENT_DIR:-}
      - PLEXBEAM_UPDATE_REPO=${PLEXBEAM_UPDATE_REPO:-local}
      - PLEXBEAM_CALLBACK_URL=${PLEXBEAM_CALLBACK_URL:-}
    volumes:
      - ${JELLYFIN_CONFIG_PATH:-./config/jellyfin}:/config
      - ${MEDIA_PATH:-/mnt/media}:/media
      - ${PLEXBEAM_JELLYFIN_LOG_PATH:-./config/plexbeam-logs}:/var/log/plexbeam

  # --- GPU Worker: NVIDIA NVENC ---
  worker-nvidia:
    build:
      context: ./worker
      dockerfile: Dockerfile.nvidia
    container_name: plexbeam-worker-nvidia
    profiles:
      - nvidia
    restart: unless-stopped
    ports:
      - "${WORKER_PORT:-8765}:8765"
    environment:
      - PLEX_WORKER_HW_ACCEL=nvenc
      - PLEX_WORKER_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEX_WORKER_MAX_JOBS=${WORKER_MAX_JOBS:-3}
      - PLEX_WORKER_HOST=0.0.0.0
      - PLEX_WORKER_PORT=8765
    volumes:
      - ${WORKER_TEMP_PATH:-./config/worker-temp}:/app/transcode_temp
      - ${WORKER_LOG_PATH:-./config/worker-logs}:/app/logs
      - ${MEDIA_PATH:-/mnt/media}:/media:ro
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu, video]

  # --- GPU Worker: Intel QSV (Linux only) ---
  # Requires Linux with /dev/dri passthrough. Does NOT work on Windows/WSL2.
  # On Linux, add /dev/dri passthrough via docker-compose.override.yml:
  #   services:
  #     worker-intel:
  #       devices:
  #         - /dev/dri:/dev/dri
  worker-intel:
    build:
      context: ./worker
      dockerfile: Dockerfile.intel
    container_name: plexbeam-worker-intel
    profiles:
      - intel
    restart: unless-stopped
    ports:
      - "${WORKER_PORT:-8765}:8765"
    environment:
      - PLEX_WORKER_HW_ACCEL=${PLEX_WORKER_HW_ACCEL:-qsv}
      - PLEX_WORKER_API_KEY=${PLEXBEAM_API_KEY:-}
      - PLEX_WORKER_MAX_JOBS=${WORKER_MAX_JOBS:-3}
      - PLEX_WORKER_HOST=0.0.0.0
      - PLEX_WORKER_PORT=8765
    volumes:
      - ${WORKER_TEMP_PATH:-./config/worker-temp}:/app/transcode_temp
      - ${WORKER_LOG_PATH:-./config/worker-logs}:/app/logs
      - ${MEDIA_PATH:-/mnt/media}:/media:ro
